@model IEnumerable<BMS_project.Models.Compliance>
@{
    Layout = "~/Views/Shared/_LayoutFederation.cshtml";
    ViewData["Title"] = "Compliance Monitoring";
}

<div class="container-fluid">

    @if (TempData["SuccessMessage"] != null)
    {
        <div id="successAlert" class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- PAGE HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Compliance Monitoring</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createComplianceModal">
            <i class="bi bi-plus-circle me-2"></i>Add Compliance
        </button>
    </div>

    <!-- Compliance Table -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success">
            <h5 class="mb-0 fw-bold text-white">Barangay Compliance Records</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Barangay</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Document Type</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.Any())
                        {
                            <tr>
                                <td colspan="7" class="text-center">No records found</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.Barangay.Barangay_Name</td>
                                    <td>@item.Title</td>
                                    <td>@item.Type</td>
                                    <td>@(string.IsNullOrEmpty(item.Annex_Type) ? "-" : item.Annex_Type)</td>
                                    <td>
                                        @if (item.Status == "Completed" || item.Status == "Approved")
                                        {
                                            <span class="badge bg-success">@item.Status</span>
                                        }
                                        else if (item.Status == "Returned" || item.Status == "Rejected")
                                        {
                                            <span class="badge bg-danger">@item.Status</span>
                                        }
                                        else if (item.Date_Submitted.HasValue)
                                        {
                                            <span class="badge bg-warning text-dark">For Review</span>
                                        }
                                        else if (item.Due_Date < DateTime.Today)
                                        {
                                            <span class="badge bg-danger">Overdue</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Not Submitted</span>
                                        }
                                    </td>
                                    <td>@item.Due_Date.ToShortDateString()</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-info me-1" 
                                                data-id="@item.Compliance_ID"
                                                onclick="openDetailsModal(this)">
                                            View
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!-- MODAL FOR CREATE COMPLIANCE REQUIREMENT -->
<div class="modal fade" id="createComplianceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <form asp-controller="Compliance" asp-action="Create" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Create New Requirement</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Validation Summary -->
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    <!-- SelectedBarangayId -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Barangay</label>
                        <select name="SelectedBarangayId" class="form-select" asp-items="@(new SelectList(ViewBag.Barangays ?? new List<SelectListItem>(), "Value", "Text"))" required>
                            <option value="">-- Select Barangay --</option>
                        </select>
                    </div>

                    <!-- Title -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Title</label>
                        <input type="text" name="Title" class="form-control" required />
                    </div>

                    <!-- DocumentType -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Document Type</label>
                        <div class="input-group">
                            <select id="docTypeSelect" name="DocumentType" class="form-select" asp-items="@(new SelectList(ViewBag.DocumentTypes ?? new List<SelectListItem>(), "Value", "Text"))" required>
                                <option value="">Select Type...</option>
                            </select>
                            <input type="text" id="docTypeInput" class="form-control d-none" placeholder="Enter custom type..." disabled />
                            <button type="button" class="btn btn-outline-secondary" id="btnToggleDocType" title="Add Custom Type">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Template File -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Template / Guide</label>
                        <input type="file" name="TemplateFile" class="form-control" accept=".pdf,.docx,.doc" required />
                        <div class="form-text">Upload a template or guide for the barangay to use (Required).</div>
                    </div>

                    <!-- DueDate -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Due Date</label>
                        <input type="date" name="DueDate" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL FOR VIEW COMPLIANCE DETAILS -->
<div class="modal fade" id="viewComplianceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Compliance Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4 border-bottom pb-2">
                    <h5 class="fw-bold text-primary mb-3" id="modalDetailsTitle"></h5>
                    <dl class="row mb-0">
                        <dt class="col-sm-4 text-muted">Barangay</dt>
                        <dd class="col-sm-8 fw-bold" id="modalDetailsBarangay"></dd>

                        <dt class="col-sm-4 text-muted">Compliance Type</dt>
                        <dd class="col-sm-8 fw-bold" id="modalDetailsType"></dd>

                        <dt class="col-sm-4 text-muted">Document Type</dt>
                        <dd class="col-sm-8 fw-bold" id="modalDetailsAnnexType"></dd>

                        <dt class="col-sm-4 text-muted">Due Date</dt>
                        <dd class="col-sm-8 fw-bold" id="modalDetailsDueDate"></dd>

                        <dt class="col-sm-4 text-muted">Overall Status</dt>
                        <dd class="col-sm-8">
                            <span class="badge" id="modalDetailsStatus"></span>
                        </dd>
                    </dl>
                </div>

                <div class="mb-2">
                    <h6 class="fw-bold">Submitted Documents</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="modalDocumentsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Document Name</th>
                                <th style="width: 120px;">Status</th>
                                <th>Remarks</th>
                                <th class="text-center" style="width: 140px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Documents injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- ARCHIVE CONFIRMATION MODAL -->
<div class="modal fade" id="archiveConfirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Archive</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to archive this record?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="archiveForm" method="post">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">Archive</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script>
        // Set Min Date for Due Date Input
        document.addEventListener("DOMContentLoaded", function() {
            var today = new Date().toISOString().split('T')[0];
            var dueDateInput = document.querySelector('input[name="DueDate"]');
            if (dueDateInput) {
                dueDateInput.setAttribute('min', today);
            }
        });

        function confirmArchive(id) {
            var form = document.getElementById('archiveForm');
            form.action = '/Compliance/Archive/' + id;
            var modal = new bootstrap.Modal(document.getElementById('archiveConfirmationModal'));
            modal.show();
        }

        function openDetailsModal(btn) {
            var id = btn.getAttribute('data-id');
            
            // Show loading or clear fields
            document.getElementById('modalDocumentsTable').querySelector('tbody').innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';
            var modal = new bootstrap.Modal(document.getElementById('viewComplianceModal'));
            modal.show();

            fetchDetails(id);
        }

        function fetchDetails(id) {
            var url = '@Url.Action("GetComplianceDetails", "FederationPresident")/' + id;
            console.log("Fetching details from:", url);

            $.get(url)
                .done(function(data) {
                    console.log("Received data:", data);
                    if (!data) {
                        alert("No data received.");
                        return;
                    }

                    // Handle Casing (CamelCase vs PascalCase)
                    var title = data.title || data.Title || "";
                    var barangayName = data.barangayName || data.BarangayName || "";
                    var type = data.complianceType || data.ComplianceType || "";
                    var annexType = data.annexType || data.Annex_Type || "-";
                    var dueDateStr = data.dueDate || data.DueDate;
                    var status = data.complianceStatus || data.ComplianceStatus || "";
                    var documents = data.documents || data.Documents || [];

                    // Populate Header Info
                    document.getElementById('modalDetailsTitle').innerText = 'Compliance Details';
                    document.getElementById('modalDetailsBarangay').innerText = barangayName;
                    document.getElementById('modalDetailsType').innerText = type;
                    document.getElementById('modalDetailsAnnexType').innerText = annexType;
                    
                    // Format Due Date
                    if (dueDateStr) {
                        const due = new Date(dueDateStr);
                        document.getElementById('modalDetailsDueDate').innerText = due.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    } else {
                        document.getElementById('modalDetailsDueDate').innerText = "-";
                    }
                    
                    // Overall Status Badge
                    var statusBadge = document.getElementById('modalDetailsStatus');
                    statusBadge.className = 'badge'; 
                    statusBadge.innerText = data.complianceStatus;
                    if(data.complianceStatus === 'Completed' || data.complianceStatus === 'Approved') statusBadge.classList.add('bg-success');
                    else if(data.complianceStatus === 'Returned' || data.complianceStatus === 'Rejected') statusBadge.classList.add('bg-danger');
                    else statusBadge.classList.add('bg-warning', 'text-dark'); // Pending/Submitted

                    // Populate Documents
                    var tbody = document.getElementById('modalDocumentsTable').querySelector('tbody');
                    tbody.innerHTML = '';

                    if(documents && documents.length > 0) {
                        documents.forEach(function(doc) {
                            var docId = doc.documentId || doc.DocumentId;
                            var docStatus = doc.status || doc.Status;
                            var docRemarks = doc.remarks || doc.Remarks;
                            var docFileName = doc.fileName || doc.FileName;
                            var docFileUrl = doc.fileUrl || doc.FileUrl;

                            var statusClass = 'bg-secondary';
                            var statusText = docStatus;

                            if(docStatus === 'Approved') {
                                statusClass = 'bg-success';
                            } else if(docStatus === 'Rejected') {
                                statusClass = 'bg-danger';
                            } else if(docStatus === 'Pending') {
                                statusClass = 'bg-warning text-dark';
                                statusText = 'For Review';
                            }

                            var actions = '';
                            if(docStatus === 'Pending') {
                                actions = `
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-success" title="Approve" onclick="reviewDocument(${docId}, 'Approved', '', ${id})">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" title="Reject" onclick="rejectDocument(${docId}, ${id})">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                `;
                            }

                            var downloadLink = `<a href="${docFileUrl}" target="_blank" class="text-decoration-none fw-semibold"><i class="bi bi-file-earmark-pdf me-1"></i>${docFileName}</a>`;

                            var row = `
                                <tr>
                                    <td>${downloadLink}</td>
                                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                                    <td class="small text-muted">${docRemarks || '-'}</td>
                                    <td class="text-center">${actions}</td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No documents submitted.</td></tr>';
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error("Error fetching details:", error);
                    console.error("Response:", xhr.responseText);
                    alert("Failed to load details. Check console for error.");
                });
        }

        function rejectDocument(docId, complianceId) {
            var remarks = prompt("Please enter remarks for rejection:");
            if (remarks === null) return; // Cancelled
            if (remarks.trim() === "") {
                alert("Remarks are required for rejection.");
                return;
            }
            reviewDocument(docId, 'Rejected', remarks, complianceId);
        }

        function reviewDocument(docId, status, remarks, complianceId) {
            $.post('/FederationPresident/ReviewDocument', { documentId: docId, status: status, remarks: remarks })
                .done(function() {
                    fetchDetails(complianceId); // Refresh
                })
                .fail(function(xhr) {
                    alert("Action failed: " + xhr.responseText);
                });
        }

        // Toggle Document Type Logic
        document.getElementById('btnToggleDocType').addEventListener('click', function() {
            var select = document.getElementById('docTypeSelect');
            var input = document.getElementById('docTypeInput');
            var icon = this.querySelector('i');

            if (input.classList.contains('d-none')) {
                // Switch to Input
                select.classList.add('d-none');
                select.disabled = true; // Don't submit
                select.required = false;

                input.classList.remove('d-none');
                input.disabled = false; // Do submit
                input.name = "DocumentType"; // Take the name
                input.required = true;
                input.focus();

                icon.classList.remove('bi-plus-lg');
                icon.classList.add('bi-x-lg'); // Change to cancel
                this.title = "Cancel Custom Type";
            } else {
                // Switch back to Select
                select.classList.remove('d-none');
                select.disabled = false;
                select.required = true;

                input.classList.add('d-none');
                input.disabled = true;
                input.name = ""; // Remove name
                input.required = false;
                input.value = ""; // Clear value

                icon.classList.remove('bi-x-lg');
                icon.classList.add('bi-plus-lg');
                this.title = "Add Custom Type";
            }
        });
    </script>
}