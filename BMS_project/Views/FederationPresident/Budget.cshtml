@model IEnumerable<BMS_project.Models.Budget>
@{
    Layout = "~/Views/Shared/_LayoutFederation.cshtml";
    ViewData["Title"] = "Barangay Budgets";
}

<div class="container-fluid">

    <!-- PAGE HEADER -->
    <div class="mb-4">
        <h2 class="fw-bold">Barangay Budget</h2>
    </div>

    <!-- Add Barangay Button -->
    <div class="col-12 text-end mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBarangayModal">
            <i class="bi bi-person-plus"></i> Add Budget
        </button>
    </div>

    <!-- MAIN CARD -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success">
            <h5 class="mb-0 fw-bold text-white">Barangay Budget</h5>
        </div>
        <div class="card-body">
            <div>
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
                }
                else if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                }
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Barangay</th>
                            <th class="text-end">Allotment</th>
                            <th class="text-end">Disbursed</th>
                            <th class="text-end">Balance</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var item in Model)
                            {
                                <tr>
                                    <td>@(item.Barangay?.Barangay_Name ?? "—")</td>
                                    <td class="text-end">₱@String.Format("{0:N2}", item.budget)</td>
                                    <td class="text-end">₱@String.Format("{0:N2}", item.disbursed)</td>
                                    <td class="text-end">₱@String.Format("{0:N2}", item.balance)</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                onclick="printCashReceipts('@(item.Barangay?.Barangay_Name)', '@String.Format("{0:N2}", item.budget)', '@String.Format("{0:N2}", item.balance)')" 
                                                title="Print Cash Receipts Register">
                                            <i class="bi bi-file-earmark-text"></i> Register
                                        </button>
                                        <button class="btn btn-sm btn-outline-success me-1" 
                                                onclick="printCertification('@(item.Barangay?.Barangay_Name)', '@String.Format("{0:N2}", item.budget)')" 
                                                title="Print Certification">
                                            <i class="bi bi-file-earmark-check"></i> Certificate
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="showDisbursementBreakdown(@item.Budget_ID, '@(item.Barangay?.Barangay_Name)')" 
                                                title="View Disbursement Breakdown">
                                            <i class="bi bi-cash-stack"></i> Disburse
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    No budget data found.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ADD BARANGAY MODAL -->
<div class="modal fade" id="addBarangayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-dark">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Add Barangay Budget</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form method="post" action="/FederationPresident/AddBarangayBudget">
                @Html.AntiForgeryToken()
                <div class="modal-body">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Barangay</label>
                        @* ViewBag.Barangays populated in controller as SelectList *@
                        @Html.DropDownList("BarangayId", (SelectList)ViewBag.Barangays, "-- Select Barangay --", new { @class = "form-select", required = "required" })
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Allotment</label>
                        <input type="number" step="0.01" class="form-control" name="Allotment" required>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success btn-sm">Save</button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- DISBURSEMENT BREAKDOWN MODAL -->
<div class="modal fade" id="disbursementModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content text-dark">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Disbursement Breakdown - <span id="modalBarangayName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="disbursementLoading" class="text-center py-4">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading disbursement data...</p>
                </div>
                <div id="disbursementContent" style="display: none;">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Project Title</th>
                                <th>Status</th>
                                <th class="text-end">Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="disbursementTableBody">
                        </tbody>
                        <tfoot class="table-light fw-bold">
                            <tr>
                                <td colspan="2" class="text-end">Total Disbursed:</td>
                                <td class="text-end" id="totalDisbursed">₱0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="disbursementEmpty" class="text-center py-4" style="display: none;">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="mt-2 text-muted">No disbursements found for this barangay.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
function printCashReceipts(barangayName, allotment, balance) {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
    const currentYear = now.getFullYear();
    
    const allotmentNum = parseFloat(allotment.replace(/,/g, ''));
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>REGISTER OF CASH RECEIPTS</title>
<style>
@@page { size: A4; margin: 15mm; }
body { font-family: "Times New Roman", serif; font-size: 11px; margin: 0; }
table { width: 100%; border-collapse: collapse; }
td, th { border: 1px solid #000; padding: 3px; vertical-align: middle; }
.center { text-align: center; }
.left { text-align: left; }
.right { text-align: right; }
.bold { font-weight: bold; }
.no-border td { border: none; }
.page-break { page-break-after: always; }
.small { font-size: 10px; }
.italic { font-style: italic; }
</style>
</head>
<body>

<p class="center bold">REGISTER OF CASH RECEIPTS, DEPOSITS AND OTHER RELATED FINANCIAL TRANSACTIONS</p>

<table>
<tr>
<td class="bold">SK of Barangay:</td>
<td class="bold">${barangayName}</td>
<td class="bold">City/Municipality:</td>
<td class="bold">CALAPAN CITY</td>
</tr>
<tr>
<td class="bold">SK Treasurer:</td>
<td class="bold">________________</td>
<td class="bold">Province:</td>
<td class="bold">ORIENTAL MINDORO</td>
</tr>
<tr>
<td class="bold">Fund:</td>
<td class="bold">10% SK FUND</td>
<td class="bold">Sheet No.:</td>
<td class="bold">${currentYear}-001</td>
</tr>
</table>

<table>
<tr class="center bold">
<td rowspan="2">Date</td>
<td rowspan="2">Reference</td>
<td rowspan="2">Name of Payor</td>
<td rowspan="2">Particulars</td>
<td colspan="3">Cash on Hand</td>
<td rowspan="2">Direct Deposit</td>
<td colspan="5">Breakdown of Receipts / Direct Deposits</td>
</tr>
<tr class="center bold">
<td>Receipt</td>
<td>Deposit</td>
<td>Balance</td>
<td>Subsidy from Barangay</td>
<td>With Specific Purpose</td>
<td>Without Specific Purpose</td>
<td><span class="italic">(Additional Receipt accounts)</span></td>
<td>Refund of Cash Advances</td>
<td>Others</td>
</tr>

<tr>
<td colspan="4" class="center italic">Total/Balance Brought Forward</td>
<td></td><td></td><td class="center">-</td>
<td></td><td></td><td></td><td></td><td></td><td></td>
</tr>

<tr>
<td>${dateStr}</td>
<td>O.R. _______</td>
<td>Barangay ${barangayName}</td>
<td>Deposit of initial deposit for opening bank account</td>
<td class="right">10,600.00</td>
<td></td>
<td class="right">10,600.00</td>
<td class="right">10,600.00</td>
<td></td><td></td><td></td><td></td><td></td>
</tr>

<tr>
<td></td>
<td>VDS (ISN) ___</td>
<td></td>
<td>Deposit of initial deposit for opening bank account</td>
<td class="right">10,600.00</td>
<td></td>
<td class="center">-</td>
<td></td><td></td><td></td><td></td><td></td><td></td>
</tr>

<tr>
<td>${dateStr}</td>
<td>O.R. _______</td>
<td>Barangay ${barangayName}</td>
<td>Receipt of 10% SK share for 6 months IRA</td>
<td class="right">${(allotmentNum * 0.10).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td></td>
<td></td>
<td></td>
<td></td><td></td><td></td><td></td><td></td>
</tr>

<tr>
<td></td>
<td>VDS (ISN) ___</td>
<td></td>
<td>Receipt of 10% SK share for 6 months IRA</td>
<td class="right">${(allotmentNum * 0.10).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td></td>
<td class="right">${(allotmentNum * 0.10).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td class="right">${(allotmentNum * 0.10).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td></td><td></td><td></td><td></td><td></td>
</tr>

<tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

<tr class="bold">
<td colspan="4" class="center">Totals for the Quarter</td>
<td class="right">${(10600 + (allotmentNum * 0.10)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td></td>
<td class="right">${(10600 + (allotmentNum * 0.10)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td class="right">${(10600 + (allotmentNum * 0.10)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td class="center">-</td><td class="center">-</td>
<td class="center">-</td><td class="center">-</td><td class="center">-</td>
</tr>

<tr class="bold">
<td colspan="4" class="center">Total/Balance Carried Forward</td>
<td class="right">${(10600 + (allotmentNum * 0.10)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td></td>
<td class="right">${(10600 + (allotmentNum * 0.10)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td class="right">${(10600 + (allotmentNum * 0.10)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
<td class="center">-</td><td class="center">-</td>
<td class="center">-</td><td class="center">-</td><td class="center">-</td>
</tr>
</table>

<br>

<p class="bold">Prepared and Certified Correct:</p>

<table class="no-border">
<tr>
<td class="center bold">_______________________</td>
<td class="center bold">${dateStr}</td>
</tr>
<tr>
<td class="center small">(Signature over Printed Name)</td>
<td class="center small">Date</td>
</tr>
<tr>
<td class="center bold">SK Treasurer</td>
<td></td>
</tr>
</table>

</body>
</html>
    `);
    printWindow.document.close();
    setTimeout(() => {
        printWindow.print();
    }, 250);
}

function printCertification(barangayName, amount) {
    const totalBudget = parseFloat(amount.replace(/,/g, ''));
    const tenPercent = totalBudget * 0.10;
    const formattedAmount = tenPercent.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    const now = new Date();
    const currentYear = now.getFullYear();
    const monthNames = ["January", "February", "March", "April", "May", "June",
                       "July", "August", "September", "October", "November", "December"];
    const day = now.getDate();
    const month = monthNames[now.getMonth()];
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Certification</title>
<style>
@@page { size: A4; margin: 25mm; }
body {
    width: 210mm;
    height: 297mm;
    margin: 0 auto;
    font-family: "Times New Roman", serif;
    font-size: 12pt;
    color: #000;
}
</style>
</head>
<body>

<p style="text-align:center; line-height:1.4;">
Republic of the Philippines<br>
Province of ORIENTAL MINDORO<br>
City/Municipality of CALAPAN CITY<br>
Barangay ${barangayName}
</p>

<br><br>

<p style="text-align:center; font-weight:bold;">
CERTIFICATION
</p>

<br><br>

<p style="text-align:left;">
To the Sangguniang Kabataan (SK) of Barangay ${barangayName}:
</p>

<br>

<p style="text-align:justify;">
This is to certify that the amount of
(₱${formattedAmount}) representing the ten (10%) of the General Fund of Barangay
${barangayName} is available for SK programs, projects, and activities as stipulated
in the approved barangay expenditure program for the Fiscal Year ${currentYear}.
</p>

<br>

<p style="text-align:justify;">
This certification is issued this ${day} day of ${month}, at Barangay
${barangayName}, City/Municipality of CALAPAN CITY.
</p>

<br><br><br>

<p style="text-align:left;">
Certified by:
</p>

<br><br>

<div style="width:220px; border-top:1px solid #000; margin-bottom:4px;"></div>
<p style="text-align:left; font-weight:bold; margin:0;">
Barangay Treasurer
</p>

</body>
</html>
    `);
    printWindow.document.close();
    setTimeout(() => {
        printWindow.print();
    }, 250);
}

function showDisbursementBreakdown(budgetId, barangayName) {
    // Set barangay name in modal
    document.getElementById('modalBarangayName').textContent = barangayName;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('disbursementModal'));
    modal.show();
    
    // Show loading, hide content
    document.getElementById('disbursementLoading').style.display = 'block';
    document.getElementById('disbursementContent').style.display = 'none';
    document.getElementById('disbursementEmpty').style.display = 'none';
    
    // Fetch disbursement data
    fetch(`/FederationPresident/GetDisbursementBreakdown?budgetId=${budgetId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('disbursementLoading').style.display = 'none';
            
            if (data && data.length > 0) {
                // Populate table
                const tbody = document.getElementById('disbursementTableBody');
                tbody.innerHTML = '';
                
                let total = 0;
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.projectTitle}</td>
                        <td><span class="badge bg-${getStatusBadgeColor(item.status)}">${item.status}</span></td>
                        <td class="text-end">₱${parseFloat(item.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${item.date ? new Date(item.date).toLocaleDateString('en-US') : '-'}</td>
                    `;
                    tbody.appendChild(row);
                    total += parseFloat(item.amount);
                });
                
                // Update total
                document.getElementById('totalDisbursed').textContent = '₱' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                document.getElementById('disbursementContent').style.display = 'block';
            } else {
                document.getElementById('disbursementEmpty').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error fetching disbursement data:', error);
            document.getElementById('disbursementLoading').style.display = 'none';
            document.getElementById('disbursementEmpty').style.display = 'block';
        });
}

function getStatusBadgeColor(status) {
    switch (status) {
        case 'Approved': return 'success';
        case 'Pending': return 'warning';
        case 'Rejected': return 'danger';
        case 'Completed': return 'info';
        default: return 'secondary';
    }
}
</script>
}