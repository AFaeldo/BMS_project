@model BMS_project.ViewModels.FederationDashboardViewModel
@{
    Layout = "~/Views/Shared/_LayoutFederation.cshtml";
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid">

    <!-- PAGE HEADER -->
    <div class="mb-4">
        <h2 class="fw-bold">Federation Dashboard</h2>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4 col-lg-3">
            <div class="card shadow-sm border-0 rounded-3 text-center py-3 h-100">
                <div class="card-body">
                    <i class="fa-solid fa-check-circle fs-2 text-success mb-2"></i>
                    <h6 class="text-muted mb-1">Approved Projects</h6>
                    <h3 class="fw-bold mb-0 animated-number" data-target="@Model.TotalApprovedProjects">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4 col-lg-3">
            <div class="card shadow-sm border-0 rounded-3 text-center py-3 h-100">
                <div class="card-body">
                    <i class="fa-solid fa-hourglass-half fs-2 text-warning mb-2"></i>
                    <h6 class="text-muted mb-1">Pending Projects</h6>
                    <h3 class="fw-bold mb-0 animated-number" data-target="@Model.TotalPendingProjects">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4 col-lg-3">
            <div class="card shadow-sm border-0 rounded-3 text-center py-3 h-100">
                <div class="card-body">
                    <i class="fa-solid fa-money-bill-wave fs-2 text-primary mb-2"></i>
                    <h6 class="text-muted mb-1">Federation Budget</h6>
                    <h3 class="fw-bold mb-0 animated-number-currency" data-target="@Model.TotalFederationBudget">₱0.00</h3>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card shadow-sm border-0 rounded-3 text-center py-3 h-100">
                <div class="card-body">
                    <i class="fa-solid fa-money-check-dollar fs-2 text-danger mb-2"></i>
                    <h6 class="text-muted mb-1">Total Disbursed</h6>
                    <h3 class="fw-bold mb-0 animated-number-currency" data-target="@Model.TotalDisbursed">₱0.00</h3>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card shadow-sm border-0 rounded-3 text-center py-3 h-100">
                <div class="card-body">
                    <i class="fa-solid fa-wallet fs-2 text-info mb-2"></i>
                    <h6 class="text-muted mb-1">Remaining Balance</h6>
                    <h3 class="fw-bold mb-0 animated-number-currency" data-target="@Model.TotalRemainingBalance">₱0.00</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <!-- BAR CHART -->
        <div class="col-12">
            <div class="card card-info card-outline h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title fw-bold">Monthly Expenses per Barangay</h5>
                </div>
                <div class="card-body">
                    <canvas id="expensesBarChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Chart.js initialization
            var ctx = document.getElementById('expensesBarChart').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: @Html.Raw(Model.MonthlyExpensesLabelsJson),
                    datasets: [{
                        label: 'Monthly Expenses (₱)',
                        data: @Html.Raw(Model.MonthlyExpensesDataJson),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)', // Bar fill color
                        borderColor: 'rgba(54, 162, 235, 1)',     // Bar border color
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow chart to take full height
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₱)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // Hide legend if only one dataset
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Number animation
            function animateNumber(element, start, end, duration, isCurrency) {
                let startTime = null;

                // Easing function (easeOutCubic)
                function easeOutCubic(t) {
                    return (--t) * t * t + 1;
                }

                function step(currentTime) {
                    if (!startTime) startTime = currentTime;
                    let progress = (currentTime - startTime) / duration;
                    progress = easeOutCubic(progress); // Apply easing function
                    progress = Math.min(progress, 1); // Clamp progress to 1

                    let currentValue = start + (end - start) * progress;

                    if (isCurrency) {
                        element.innerText = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(currentValue);
                    } else {
                        element.innerText = Math.floor(currentValue);
                    }

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        // Ensure final value is exactly the target
                        if (isCurrency) {
                            element.innerText = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(end);
                        } else {
                            element.innerText = end;
                        }
                    }
                }
                requestAnimationFrame(step);
            }

            document.querySelectorAll('.animated-number').forEach(element => {
                const target = parseInt(element.dataset.target);
                animateNumber(element, 0, target, 1500, false); // 1.5 seconds duration
            });

            document.querySelectorAll('.animated-number-currency').forEach(element => {
                const target = parseFloat(element.dataset.target);
                animateNumber(element, 0, target, 1500, true); // 1.5 seconds duration
            });
        });
    </script>
