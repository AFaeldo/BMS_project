@{
    Layout = "~/Views/Shared/_LayoutSuperAdmin.cshtml";
    ViewData["Title"] = "Manage Users";
}
<div class="container-fluid">

    <!-- PAGE HEADER -->
    <div class="mb-4">
        <h2 class="fw-bold">Manage User</h2>
    </div>

    <div class="col-12 text-end mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalUserSuper">
            <i class="bi bi-person-plus me-1"></i> Add / Edit User
        </button>
    </div>

    <!-- USERS TABLE -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0 fw-bold">Registered Users</h5>
        </div>

        <div class="card-body p-3">
            <div class="table-responsive">
                <table id="tblManageUsers" class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Username</th>
                            <th>Last Name</th>
                            <th>First Name</th>
                            <th>Barangay</th>
                            <th>Role</th>
                            <th>Email</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated by AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- MODAL: ADD / EDIT USER -->
<div class="modal fade" id="modalUserSuper" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form id="formUserSuper" class="modal-content" onsubmit="return false;">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add / Edit User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input id="Super_UserId" type="hidden" value="0">

                <div class="row g-3">

                    <div class="col-md-4">
                        <label class="form-label">Last Name</label>
                        <input id="Super_LastName" class="form-control" maxlength="100" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">First Name</label>
                        <input id="Super_FirstName" class="form-control" maxlength="100" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input id="Super_Email" class="form-control" type="email" maxlength="200" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Barangay</label>
                        <select id="Super_Barangay" class="form-select" required>
                            <option value="">-- Select Barangay --</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Role</label>
                        <select id="Super_Role" class="form-select" required>
                            <option value="">-- Select Role --</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Username</label>
                        <input id="Super_Username" class="form-control" maxlength="100" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Password</label>
                        <input id="Super_Password" class="form-control" type="password" minlength="8">
                        <div class="form-text">Leave blank to keep current password.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Confirm Password</label>
                        <input id="Super_ConfirmPassword" class="form-control" type="password" minlength="8">
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                <button id="btnSaveSuper" class="btn btn-success" type="button">Save</button>
            </div>

        </form>
    </div>
</div>


<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (function ($) {
        'use strict';

        const api = {
            list: '/api/users',
            get: id => `/api/users/${id}`,
            create: '/api/users',
            update: id => `/api/users/${id}`,
            delete: id => `/api/users/${id}`
        };

        function showToast(msg) {
            $("#toastMsg").text(msg);
            new bootstrap.Toast(document.getElementById("appToast")).show();
        }

        function refreshTable() {
            $.get(api.list)
                .done(data => renderRows(data))
                .fail(() => showToast("Failed to load users."));
        }

        function renderRows(data) {
            const tbody = $("#tblManageUsers tbody").empty();
            data.forEach(u => {
                tbody.append(`
                    <tr data-userid="${u.id}">
                        <td>${u.username}</td>
                        <td>${u.lastName}</td>
                        <td>${u.firstName}</td>
                        <td>${u.barangayName}</td>
                        <td>${u.role}</td>
                        <td>${u.email}</td>
                        <td class="text-center">
                            <span class="badge ${u.isActive ? "bg-success" : "bg-secondary"}">
                                ${u.isActive ? "Active" : "Inactive"}
                            </span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary btn-edit me-1">Edit</button>
                            <button class="btn btn-sm btn-danger btn-delete">Delete</button>
                        </td>
                    </tr>
                `);
            });
        }

        $(function () {

            refreshTable();

            $("#btnAddUserSuper").on("click", () => {
                $("#formUserSuper")[0].reset();
                $("#Super_UserId").val(0);
            });

            $("#tblManageUsers").on("click", ".btn-edit", function () {
                const id = $(this).closest("tr").data("userid");

                $.get(api.get(id)).done(u => {
                    $("#Super_UserId").val(u.id);
                    $("#Super_LastName").val(u.lastName);
                    $("#Super_FirstName").val(u.firstName);
                    $("#Super_Email").val(u.email);
                    $("#Super_Barangay").val(u.barangayId);
                    $("#Super_Role").val(u.role);
                    $("#Super_Username").val(u.username);
                    $("#Super_Password").val("");
                    $("#Super_ConfirmPassword").val("");

                    new bootstrap.Modal($("#modalUserSuper")).show();
                });
            });

            $("#btnSaveSuper").on("click", function () {
                const pwd = $("#Super_Password").val();
                const cpwd = $("#Super_ConfirmPassword").val();

                if (pwd || cpwd) {
                    if (pwd.length < 8) return showToast("Password must be at least 8 characters.");
                    if (pwd !== cpwd) return showToast("Passwords do not match.");
                }

                showToast("Save endpoint not implemented. Connect to your API.");
            });

            $("#tblManageUsers").on("click", ".btn-delete", function () {
                const id = $(this).closest("tr").data("userid");
                if (!confirm("Delete this user?")) return;
                showToast("Delete endpoint not implemented.");
            });

        });

    })(jQuery);
</script>
