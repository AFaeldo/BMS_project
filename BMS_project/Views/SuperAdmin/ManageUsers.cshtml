@{
    Layout = "~/Views/Shared/_LayoutSuperAdmin.cshtml";
    ViewData["Title"] = "Manage Users";
}

<div class="container-fluid">

    <!-- PAGE HEADER -->
    <div class="mb-4">
        <h2 class="fw-bold">Manage Users</h2>
    </div>

    <div class="col-12 text-end mb-3">
        <button id="btnAddUserSuper" class="btn btn-primary">
            <i class="bi bi-person-plus me-1"></i> Add / Edit User
        </button>
    </div>

    <!-- USERS TABLE -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0 fw-bold">Registered Users</h5>
        </div>

        <div class="card-body p-3">
            <div class="table-responsive">
                <table id="tblManageUsers" class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Username</th>
                            <th>Last Name</th>
                            <th>First Name</th>
                            <th>Barangay</th>
                            <th>Role</th>
                            <th>Email</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated by AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: ADD / EDIT USER -->
<div class="modal fade" id="modalUserSuper" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form id="formUserSuper" class="modal-content" onsubmit="return false;">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add / Edit User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <input id="Super_UserId" type="hidden" value="0">

                <div class="row g-3">

                    <div class="col-md-4">
                        <label class="form-label">Last Name</label>
                        <input id="Super_LastName" class="form-control" maxlength="100" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">First Name</label>
                        <input id="Super_FirstName" class="form-control" maxlength="100" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input id="Super_Email" class="form-control" type="email" maxlength="200" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Barangay</label>
                        <select id="Super_Barangay" class="form-select" required>
                            <option value="">-- Select Barangay --</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Role</label>
                        <select id="Super_Role" class="form-select" required>
                            <option value="">-- Select Role --</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Username</label>
                        <input id="Super_Username" class="form-control" maxlength="100" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Password</label>
                        <input id="Super_Password" class="form-control" type="password" minlength="8">
                        <div class="form-text">Leave blank to keep current password (when editing).</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Confirm Password</label>
                        <input id="Super_ConfirmPassword" class="form-control" type="password" minlength="8">
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                <button id="btnSaveSuper" class="btn btn-success" type="button">Save</button>
            </div>

        </form>
    </div>
</div>

<!-- Toast (simple) -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <small class="text-muted"></small>
            <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMsg"></div>
    </div>
</div>

<!-- JS libs -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Page script -->
<script>
(function ($) {
    'use strict';

    const api = {
        list: '/api/users',
        get: id => `/api/users/${id}`,
        create: '/api/users',
        update: id => `/api/users/${id}`,
        delete: id => `/api/users/${id}`,
        barangays: '/api/users/barangays',
        roles: '/api/users/roles'
    };

    // Bootstrap modal instance
    const modalEl = document.getElementById('modalUserSuper');
    const userModal = new bootstrap.Modal(modalEl);

    function showToast(msg) {
        $("#toastMsg").text(msg);
        const toast = new bootstrap.Toast(document.getElementById("appToast"));
        toast.show();
    }

    function refreshTable() {
        $.get(api.list)
            .done(data => renderRows(data))
            .fail(() => showToast("Failed to load users."));
    }

    function renderRows(data) {
        const tbody = $("#tblManageUsers tbody").empty();
        data.forEach(u => {
            tbody.append(`
                <tr data-userid="${u.id}">
                    <td>${escapeHtml(u.username)}</td>
                    <td>${escapeHtml(u.lastName || '')}</td>
                    <td>${escapeHtml(u.firstName || '')}</td>
                    <td>${escapeHtml(u.barangayName || '')}</td>
                    <td>${escapeHtml(u.role || '')}</td>
                    <td>${escapeHtml(u.email || '')}</td>
                    <td class="text-center">
                        <span class="badge ${u.isActive ? "bg-success" : "bg-secondary"}">
                            ${u.isActive ? "Active" : "Inactive"}
                        </span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary btn-edit me-1">Edit</button>
                        <button class="btn btn-sm btn-danger btn-delete">Delete</button>
                    </td>
                </tr>
            `);
        });
    }

    // simple HTML escape for safety
    function escapeHtml(str) {
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    //populate barangays and roles
    function loadDropdowns() {
        //barangays
        $.get(api.barangays).done(list => {
            const sel = $("#Super_Barangay").empty().append('<option value="">-- Select Barangay --</option>');
            list.forEach(b => sel.append(`<option value="${b.id}">${escapeHtml(b.text)}</option>`));
        }).fail(() => showToast("Failed to load barangays."));

        //roles
        $.get(api.roles).done(list => {
            const sel = $("#Super_Role").empty().append('<option value="">-- Select Role --</option>');
            list.forEach(r => sel.append(`<option value="${r.id}">${escapeHtml(r.text)}</option>`));
        }).fail(() => showToast("Failed to load roles."));
    }

    $(function () {
        loadDropdowns();
        refreshTable();

        //Add button opens blank modal
        $("#btnAddUserSuper").on("click", () => {
            $("#formUserSuper")[0].reset();
            $("#Super_UserId").val(0);
            loadDropdowns();
            userModal.show();
        });

        //Edit row
        $("#tblManageUsers").on("click", ".btn-edit", function () {
            const id = $(this).closest("tr").data("userid");

            $.get(api.get(id)).done(u => {
                $("#Super_UserId").val(u.id || 0);
                $("#Super_LastName").val(u.lastName || '');
                $("#Super_FirstName").val(u.firstName || '');
                $("#Super_Email").val(u.email || '');
                $("#Super_Barangay").val(u.barangayId || '');
                $("#Super_Role").val(u.roleId || '');
                $("#Super_Username").val(u.username || '');
                $("#Super_Password").val('');
                $("#Super_ConfirmPassword").val('');

                // ensure dropdowns are loaded and then show modal
                loadDropdowns();
                // small timeout to let options render then set selected value
                setTimeout(() => {
                    $("#Super_Barangay").val(u.barangayId || '');
                    $("#Super_Role").val(u.roleId || '');
                    userModal.show();
                }, 80);
            }).fail(() => showToast("Failed to load user data."));
        });

        // Save (create or update)
        $("#btnSaveSuper").on("click", function () {
            const id = Number($("#Super_UserId").val() || 0);
            const payload = {
                Username: $("#Super_Username").val().trim(),
                Password: $("#Super_Password").val(),
                FirstName: $("#Super_FirstName").val().trim(),
                LastName: $("#Super_LastName").val().trim(),
                Email: $("#Super_Email").val().trim(),
                BarangayId: Number($("#Super_Barangay").val() || 0) || null,
                RoleId: Number($("#Super_Role").val() || 0) || null
            };

            // client validation
            if (!payload.Username) return showToast("Enter username.");
            if (!id && !payload.Password) return showToast("Password required for new user.");
            if (payload.Password && payload.Password.length < 8) return showToast("Password must be at least 8 characters.");
            if ($("#Super_Password").val() !== $("#Super_ConfirmPassword").val()) return showToast("Passwords do not match.");

            if (!id) {
                // create
                $.ajax({
                    url: api.create,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload)
                }).done(() => {
                    showToast("User created.");
                    refreshTable();
                    userModal.hide();
                }).fail(xhr => showToast(xhr.responseText || "Create failed."));
            } else {
                // update
                $.ajax({
                    url: api.update(id),
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(payload)
                }).done(() => {
                    showToast("User updated.");
                    refreshTable();
                    userModal.hide();
                }).fail(xhr => showToast(xhr.responseText || "Update failed."));
            }
        });

        // Delete
        $("#tblManageUsers").on("click", ".btn-delete", function () {
            const id = $(this).closest("tr").data("userid");
            if (!confirm("Delete this user?")) return;
            $.ajax({
                url: api.delete(id),
                method: 'DELETE'
            }).done(() => {
                showToast("Deleted.");
                refreshTable();
            }).fail(xhr => showToast(xhr.responseText || "Delete failed."));
        });
    });

})(jQuery);
</script>
