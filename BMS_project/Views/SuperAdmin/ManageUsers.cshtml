@{
    Layout = "~/Views/Shared/_LayoutSuperAdmin.cshtml";
    ViewData["Title"] = "Manage Users";
}

<div class="container-fluid">

    <!-- PAGE HEADER -->
    <div class="mb-4">
        <h2 class="fw-bold">Manage Users</h2>
    </div>

    <!-- Search + Add button row -->
    <div class="d-flex justify-content-between align-items-center mb-3">

        <!-- Search (client-side) -->
        <form id="userSearchForm" class="d-flex" style="gap: 10px;">
            <input type="text"
                   id="searchText"
                   name="search"
                   value="@ViewBag.Search"
                   class="form-control"
                   placeholder="Search....."
                   style="width: 230px;" />
            <button type="submit" class="btn btn-primary">
                Search
            </button>
        </form>

        <!-- Add User Button -->
        <div>
            <button id="btnViewArchived" class="btn btn-secondary me-2">
                <i class="bi bi-archive me-1"></i> View Archived
            </button>
            <button id="btnAddUserSuper" class="btn btn-primary">
                <i class="bi bi-person-plus me-1"></i> Add User
            </button>
        </div>

    </div>


    <!-- USERS TABLE -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0 fw-bold">Registered Users</h5>
        </div>

        <div class="card-body p-3">
            <div class="table-responsive">
                <table id="tblManageUsers" class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Username</th>
                            <th>Last Name</th>
                            <th>First Name</th>
                            <th>Barangay</th>
                            <th>Role</th>
                            <th>Term Period</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @* rows are injected via JS *@
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PAGINATION AREA -->
        <div class="card-footer bg-white">
            <nav aria-label="User pagination">
                <ul class="pagination justify-content-end mb-0" id="userPagination">
                    @* JS will render page links here *@
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- MODAL: ARCHIVED USERS -->
<div class="modal fade" id="modalArchivedUsers" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="bi bi-archive me-2"></i>Archived Users</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table id="tblArchivedUsers" class="table table-hover align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Select</th>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Role</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will inject rows -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-light" data-bs-dismiss="modal">Close</button>
                <button id="btnRestoreSelected" class="btn btn-success px-4">Re-elect Selected</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: ADD USER -->
<div class="modal fade" id="modalAddUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form id="formAddUser" class="modal-content shadow-lg border-0 rounded-3" onsubmit="return false;">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> Add User
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Last Name</label>
                        <input id="Add_LastName" class="form-control" maxlength="100" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">First Name</label>
                        <input id="Add_FirstName" class="form-control" maxlength="100" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Email</label>
                        <input id="Add_Email" class="form-control" type="email" maxlength="200" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Barangay</label>
                        <select id="Add_Barangay" class="form-select" required>
                            <option value="">-- Select Barangay --</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Role</label>
                        <select id="Add_Role" class="form-select" required>
                            <option value="">-- Select Role --</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Username</label>
                        <input id="Add_Username" class="form-control" maxlength="100" readonly />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Password</label>
                        <input id="Add_Password" class="form-control" type="password" minlength="8" required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Confirm Password</label>
                        <input id="Add_ConfirmPassword" class="form-control" type="password" minlength="8" required />
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0">
                <button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal" type="button">Cancel</button>
                <button id="btnSaveAdd" class="btn btn-success px-4" type="button">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: EDIT USER -->
<div class="modal fade" id="modalEditUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form id="formEditUser" class="modal-content shadow-lg border-0 rounded-3" onsubmit="return false;">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i> Edit User
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <input id="Edit_UserId" type="hidden" value="0" />

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Last Name</label>
                        <input id="Edit_LastName" class="form-control" maxlength="100" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">First Name</label>
                        <input id="Edit_FirstName" class="form-control" maxlength="100" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Email</label>
                        <input id="Edit_Email" class="form-control" type="email" maxlength="200" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Barangay</label>
                        <select id="Edit_Barangay" class="form-select" required>
                            <option value="">-- Select Barangay --</option>
                        </select>
                    </div>

                    <!-- ROLE REMOVED FOR EDIT -->
                    <div class="col-md-6 d-flex align-items-center">
                        <span class="text-muted fst-italic">Role cannot be changed in Edit mode.</span>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Username</label>
                        <input id="Edit_Username" class="form-control" maxlength="100" readonly />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">New Password (Optional)</label>
                        <input id="Edit_Password" class="form-control" type="password" minlength="8" placeholder="Leave blank to keep" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Confirm New Password</label>
                        <input id="Edit_ConfirmPassword" class="form-control" type="password" minlength="8" placeholder="Leave blank to keep" />
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0">
                <button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal" type="button">Cancel</button>
                <button id="btnSaveEdit" class="btn btn-warning px-4" type="button">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: RESIGN / ARCHIVE CONFIRMATION -->
<div class="modal fade" id="modalArchiveUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow border-0 rounded-3">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Confirm Resignation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <input type="hidden" id="archiveUserId" />
                <p id="archiveMessage" class="mb-3 text-black"></p>
                <div class="d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" id="btnConfirmArchive" class="btn btn-danger px-4">
                        <i class="bi bi-box-arrow-right"></i> Confirm Resign
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification/Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <small class="text-dark"></small>
            <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMsg"></div>
    </div>
</div>

<!-- JS libs -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Page script -->
<script>
    (function ($) {
        'use strict';

        const api = {
            list: '/api/users',
            archived_list: '/api/users/archived',
            get: id => `/api/users/${id}`,
            create: '/api/users',
            update: id => `/api/users/${id}`,
            delete: id => `/api/users/${id}`,
            archive: id => `/api/users/${id}/archive`,
            restore: '/api/users/restore',
            barangays: '/api/users/barangays',
            roles: '/api/users/roles'
        };

        const addModal = new bootstrap.Modal(document.getElementById('modalAddUser'));
        const editModal = new bootstrap.Modal(document.getElementById('modalEditUser'));
        
        const modalArchivedEl = document.getElementById('modalArchivedUsers');
        const archivedModal = new bootstrap.Modal(modalArchivedEl);

        const modalArchiveConfirmEl = document.getElementById('modalArchiveUser');
        const archiveConfirmModal = new bootstrap.Modal(modalArchiveConfirmEl);

        function showToast(msg) {
            $("#toastMsg").text(msg);
            const toast = new bootstrap.Toast(document.getElementById("appToast"));
            toast.show();
        }

        function refreshTable(page = 1) {
            $.get(api.list, { page })
                .done(data => {
                    renderRows(data.items || data);
                })
                .fail(() => showToast("Failed to load users."));
        }

        function renderRows(data) {
            const tbody = $("#tblManageUsers tbody").empty();
            if (!data || data.length === 0) {
                tbody.append('<tr><td colspan="7" class="text-center">No users found.</td></tr>');
                return;
            }
            data.forEach(u => {
                tbody.append(`
                    <tr data-userid="${u.id}">
                        <td>${escapeHtml(u.username)}</td>
                        <td>${escapeHtml(u.lastName || '')}</td>
                        <td>${escapeHtml(u.firstName || '')}</td>
                        <td>${escapeHtml(u.barangayName || '')}</td>
                        <td>${escapeHtml(u.role || '')}</td>
                        <td>${escapeHtml(u.term || 'N/A')}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning text-white btn-edit me-1" title="Edit">
                                <i class="bi bi-pencil-square"></i> Edit
                            </button>
                            ${u.role === "SuperAdmin" ? '' : `
                            <button class="btn btn-sm btn-danger btn-archive" title="Resign / Step Down">
                                <i class="bi bi-box-arrow-right"></i> Resign
                            </button>
                            `}
                        </td>
                    </tr>
                `);
            });
        }

        function loadArchivedUsers() {
            $.get(api.archived_list)
                .done(data => {
                    const tbody = $("#tblArchivedUsers tbody").empty();
                    if (!data || data.length === 0) {
                        tbody.append('<tr><td colspan="4" class="text-muted">No archived users found.</td></tr>');
                        return;
                    }
                    data.forEach(u => {
                        tbody.append(`
                            <tr>
                                <td><input type="checkbox" class="form-check-input restore-check" value="${u.id}"></td>
                                <td>${escapeHtml(u.username)}</td>
                                <td>${escapeHtml((u.firstName || '') + ' ' + (u.lastName || ''))}</td>
                                <td>${escapeHtml(u.role || '')}</td>
                            </tr>
                        `);
                    });
                    archivedModal.show();
                })
                .fail(() => showToast("Failed to load archived users."));
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function loadDropdowns() {
            // Load Barangays for BOTH Add and Edit
            $.get(api.barangays).done(list => {
                const addSel = $("#Add_Barangay").empty().append('<option value="">-- Select Barangay --</option>');
                const editSel = $("#Edit_Barangay").empty().append('<option value="">-- Select Barangay --</option>');
                
                list.forEach(b => {
                    const opt = `<option value="${b.id}">${escapeHtml(b.text)}</option>`;
                    addSel.append(opt);
                    editSel.append(opt);
                });
            }).fail(() => showToast("Failed to load barangays."));

            // Load Roles for ADD only
            $.get(api.roles).done(list => {
                const sel = $("#Add_Role")
                    .empty()
                    .append('<option value="">-- Select Role --</option>');
                list.filter(r => r.text !== "SuperAdmin").forEach(r => sel.append(`<option value="${r.id}">${escapeHtml(r.text)}</option>`));
            }).fail(() => showToast("Failed to load roles."));
        }

        $(function () {
            loadDropdowns();
            refreshTable();

            // Handle Role Change to toggle Barangay requirement (Add Modal Only)
            $("#Add_Role").on("change", function() {
                const text = $(this).find("option:selected").text();
                if (text === "SuperAdmin") {
                    $("#Add_Barangay").val("").prop("disabled", true);
                } else {
                    $("#Add_Barangay").prop("disabled", false);
                }
            });

            // OPEN ADD MODAL
            $("#btnAddUserSuper").on("click", () => {
                $("#formAddUser")[0].reset();
                loadDropdowns(); 

                $.get('/api/users/generate-username')
                    .done(res => {
                        $("#Add_Username").val(res.username || '');
                        addModal.show();
                    })
                    .fail(() => {
                        showToast("Failed to generate username. You can type one manually.");
                        addModal.show();
                    });
            });

            // SAVE NEW USER
            $("#btnSaveAdd").on("click", function () {
                const payload = {
                    Username: $("#Add_Username").val().trim(),
                    Password: $("#Add_Password").val(),
                    FirstName: $("#Add_FirstName").val().trim(),
                    LastName: $("#Add_LastName").val().trim(),
                    Email: $("#Add_Email").val().trim(),
                    BarangayId: Number($("#Add_Barangay").val() || 0) || null,
                    RoleId: Number($("#Add_Role").val() || 0) || null
                };

                // Basic Validations
                if (!payload.Username) return showToast("Enter username.");
                if (!payload.Password) return showToast("Password required.");
                if (payload.Password.length < 8) return showToast("Password must be at least 8 characters.");
                if ($("#Add_Password").val() !== $("#Add_ConfirmPassword").val()) return showToast("Passwords do not match.");
                if (!payload.RoleId) return showToast("Role is required.");

                $.ajax({
                    url: api.create,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload)
                }).done(() => {
                    showToast("User created.");
                    refreshTable();
                    addModal.hide();
                }).fail(xhr => {
                    showToast(xhr.responseText || "Create failed.");
                });
            });

            // OPEN EDIT MODAL
            $("#tblManageUsers").on("click", ".btn-edit", function () {
                const id = $(this).closest("tr").data("userid");

                $.get(api.get(id)).done(u => {
                    $("#Edit_UserId").val(u.id || 0);
                    $("#Edit_LastName").val(u.lastName || '');
                    $("#Edit_FirstName").val(u.firstName || '');
                    $("#Edit_Email").val(u.email || '');
                    $("#Edit_Username").val(u.username || '');
                    
                    // Reset password fields
                    $("#Edit_Password").val('');
                    $("#Edit_ConfirmPassword").val('');
                    
                    loadDropdowns(); // Refresh dropdowns to ensure up-to-date lists
                    
                    setTimeout(() => {
                        $("#Edit_Barangay").val(u.barangayId || '');
                        editModal.show();
                    }, 80);
                }).fail(() => showToast("Failed to load user data."));
            });

            // UPDATE USER
            $("#btnSaveEdit").on("click", function () {
                const id = Number($("#Edit_UserId").val() || 0);
                const payload = {
                    Id: id,
                    Username: $("#Edit_Username").val().trim(),
                    Password: $("#Edit_Password").val(),
                    FirstName: $("#Edit_FirstName").val().trim(),
                    LastName: $("#Edit_LastName").val().trim(),
                    Email: $("#Edit_Email").val().trim(),
                    BarangayId: Number($("#Edit_Barangay").val() || 0) || null,
                    RoleId: null // Role is not editable
                };

                if (!payload.Username) return showToast("Enter username.");
                // Password optional on edit
                if (payload.Password && payload.Password.length < 8) return showToast("Password must be at least 8 characters.");
                if ($("#Edit_Password").val() !== $("#Edit_ConfirmPassword").val()) return showToast("Passwords do not match.");

                $.ajax({
                    url: api.update(id),
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(payload)
                }).done(() => {
                    showToast("User updated.");
                    refreshTable();
                    editModal.hide();
                }).fail(xhr => {
                    showToast(xhr.responseText || "Update failed.");
                });
            });

            $("#btnViewArchived").on("click", () => {
                loadArchivedUsers();
            });

            $("#btnRestoreSelected").on("click", () => {
                const selectedIds = [];
                $(".restore-check:checked").each(function() {
                    selectedIds.push(Number($(this).val()));
                });

                if (selectedIds.length === 0) return showToast("No users selected.");

                $.ajax({
                    url: api.restore,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(selectedIds)
                }).done(() => {
                    showToast("Users re-elected to current term.");
                    archivedModal.hide();
                    refreshTable();
                }).fail(xhr => {
                    showToast(xhr.responseText || "Re-election failed.");
                });
            });

            // TRIGGER ARCHIVE (RESIGN) MODAL
            $("#tblManageUsers").on("click", ".btn-archive", function () {
                const tr = $(this).closest("tr");
                const id = tr.data("userid");
                const name = tr.find("td:nth-child(3)").text() + " " + tr.find("td:nth-child(2)").text(); // First Last

                $("#archiveUserId").val(id);
                $("#archiveMessage").html(`Are you sure you want to force resign <strong>${name}</strong>?<br>This will archive the user and end their term.`);
                archiveConfirmModal.show();
            });

            // CONFIRM ARCHIVE ACTION
            $("#btnConfirmArchive").on("click", function() {
                const id = $("#archiveUserId").val();
                
                $.ajax({
                    url: api.archive(id),
                    method: 'POST'
                }).done(() => {
                    showToast("User resigned and archived.");
                    refreshTable();
                    archiveConfirmModal.hide();
                }).fail(xhr => {
                    showToast(xhr.responseText || "Action failed.");
                });
            });
        });

        // pagination click handler (delegated)
        $(document).on("click", ".page-nav", function (e) {
            e.preventDefault();
            const page = Number($(this).data("page") || 1);
            if (page <= 0) return;
            refreshTable(page);
        });

    })(jQuery);
</script>