@model IEnumerable<BMS_project.ViewModels.ComplianceViewModel>
@{
    Layout = "~/Views/Shared/_BarangayLayout.cshtml";
    ViewData["Title"] = "Compliance";
}

<div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="fw-bold">Compliance Requirements</h2>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0 fw-bold">Required Documents</h5>
        </div>
        <div class="card-body">
            @if (Model == null || !Model.Any())
            {
                <div class="text-center py-4">
                    <p class="text-muted mb-0">No compliance requirements found.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Submission Date</th>
                                <th class="text-center">SK Federation Uploaded Files</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.Title</td>
                                    <td>@item.Type</td>
                                    <td>@item.DueDate.ToShortDateString()</td>
                                    <td>
                                        @if (item.Status == "Approved")
                                        {
                                            <span class="badge bg-success">Approved</span>
                                        }
                                        else if (item.Status == "Completed")
                                        {
                                            <span class="badge bg-success">Completed</span>
                                        }
                                        else if (item.Status == "Returned" || item.Status == "Rejected")
                                        {
                                            <span class="badge bg-danger">@item.Status</span>
                                        }
                                        else if (item.Status == "Pending" || item.Date_Submitted.HasValue)
                                        {
                                            <span class="badge bg-warning text-dark">For Review</span>
                                        }
                                        else if (item.DueDate < DateTime.Today)
                                        {
                                            <span class="badge bg-danger">Overdue</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Not Submitted</span>
                                        }
                                    </td>
                                    <td>@(item.Date_Submitted.HasValue ? item.Date_Submitted.Value.ToShortDateString() : "-")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="openFederationFilesModal(@item.Compliance_ID, '@Html.Raw(item.Title.Replace("'", "\\'"))')">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                    <td class="text-center">
                                        @if (item.Status == "Returned" || item.Status == "Rejected")
                                        {
                                            <button class="btn btn-sm btn-warning text-dark btn-upload" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#uploadModal"
                                                    data-id="@item.Compliance_ID"
                                                    data-title="@item.Title">
                                                Re-Submit
                                            </button>
                                        }
                                        else if (item.Type == "Project Proposal")
                                        {
                                            if (item.Status == "Not Submitted")
                                            {
                                                <button class="btn btn-sm btn-primary btn-upload" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#uploadModal"
                                                        data-id="@item.Compliance_ID"
                                                        data-title="@item.Title">
                                                    Submit
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-info text-white" 
                                                        onclick="openDetailsModal(@item.Compliance_ID)">
                                                    View
                                                </button>
                                            }
                                        }
                                        else if (item.Date_Submitted.HasValue)
                                        {
                                            <button class="btn btn-sm btn-info text-white" 
                                                    onclick="openDetailsModal(@item.Compliance_ID)">
                                                View
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-primary btn-upload" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#uploadModal"
                                                    data-id="@item.Compliance_ID"
                                                    data-title="@item.Title">
                                                Submit
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Generation of Reports Card -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">Generation of Reports</h5>
            <button type="button" class="btn btn-light btn-sm" onclick="printGenerationReports()">
                <i class="bi bi-printer me-1"></i> Print Reports
            </button>
        </div>
        <div class="card-body">
            <!-- Filter Section -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Search Project:</label>
                    <input type="text" id="projectSearchFilter" class="form-control" placeholder="Search by project title..." onkeyup="filterReportsTable()">
                </div>
            </div>
            @{
                var approvedProjects = ViewBag.ApprovedProjects as List<BMS_project.Models.Project>;
            }
            @if (approvedProjects == null || !approvedProjects.Any())
            {
                <div class="text-center py-4">
                    <p class="text-muted mb-0">No approved projects found.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="reportsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Project Title</th>
                                <th>Status</th>
                                <th>Date Submitted</th>
                                <th class="text-center">Barangay SK Documents</th>
                                <th class="text-center">Barangay Federation</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var project in approvedProjects)
                            {
                                <tr data-project-id="@project.Project_ID">
                                    <td class="project-title">@project.Project_Title</td>
                                    <td>
                                        <span class="badge bg-success project-status">@project.Project_Status</span>
                                    </td>
                                    <td class="date-submitted">@(project.Date_Submitted.HasValue ? project.Date_Submitted.Value.ToShortDateString() : "-")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="openBarangayDocsModal(@project.Project_ID, '@Html.Raw(project.Project_Title.Replace("'", "\\'"))')">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-info text-white" 
                                                onclick="openFederationDocsModal(@project.Project_ID, '@Html.Raw(project.Project_Title.Replace("'", "\\'"))')">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form asp-action="SubmitCompliance" method="post" enctype="multipart/form-data" class="modal-content">
            @Html.AntiForgeryToken()
            <input type="hidden" name="ComplianceId" id="modalComplianceId" />
            
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Submit Compliance Documents</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Requirement</label>
                    <input type="text" class="form-control-plaintext" id="modalTitle" readonly />
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Document Type</label>
                    <select name="AnnexType" class="form-select" required>
                        <option value="">-- Select Document Type --</option>
                        <option value="Summary">Summary</option>
                        <option value="Liquidation">Liquidation</option>
                        <option value="Expenses">Expenses</option>
                    </select>
                </div>
                
                <label class="form-label fw-bold">Upload Documents (PDF)</label>
                <div id="fileInputsContainer">
                    <div class="mb-2">
                        <input type="file" name="SubmissionFiles" class="form-control" accept="application/pdf" required />
                    </div>
                </div>
                
                <button type="button" class="btn btn-outline-secondary btn-sm mb-3" id="addFileBtn">
                    <i class="bi bi-plus-circle me-1"></i> Add Another Document
                </button>
                
                <div class="form-text">Max 25MB per file. Only PDF files allowed.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewComplianceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Compliance Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4 border-bottom pb-2">
                    <h5 class="fw-bold text-primary mb-3" id="modalDetailsTitle"></h5>
                    <dl class="row mb-0">
                        <dt class="col-sm-4 text-muted">Compliance Type</dt>
                        <dd class="col-sm-8 fw-bold" id="modalDetailsType"></dd>

                        <dt class="col-sm-4 text-muted">Due Date</dt>
                        <dd class="col-sm-8 fw-bold" id="modalDetailsDueDate"></dd>

                        <dt class="col-sm-4 text-muted">Overall Status</dt>
                        <dd class="col-sm-8">
                            <span class="badge" id="modalDetailsStatus"></span>
                        </dd>
                    </dl>
                </div>

                <div class="mb-2">
                    <h6 class="fw-bold">Submitted Documents</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="modalDocumentsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Document Name</th>
                                <th style="width: 120px;">Status</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Documents injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Barangay SK Documents Modal -->
<div class="modal fade" id="barangayDocsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Barangay SK Documents</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 border-bottom pb-2">
                    <h6 class="fw-bold text-primary" id="barangayDocsProjectTitle"></h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="barangayDocsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Document Name</th>
                                <th>Type</th>
                                <th style="width: 150px;">Date Added</th>
                                <th style="width: 120px;" class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Documents injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Federation Documents Modal -->
<div class="modal fade" id="federationDocsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Barangay Federation Documents</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 border-bottom pb-2">
                    <h6 class="fw-bold text-info" id="federationDocsProjectTitle"></h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="federationDocsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Document Name</th>
                                <th>Type</th>
                                <th style="width: 150px;">Date Added</th>
                                <th style="width: 120px;" class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Documents injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- SK Federation Files Modal -->
<div class="modal fade" id="federationFilesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0 rounded-3">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>Uploaded Files</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted">Project Title</label>
                    <input type="text" class="form-control-plaintext border px-2 py-1 bg-light" id="federationFilesComplianceTitle" readonly>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="federationFilesTable">
                        <thead class="table-light">
                            <tr>
                                <th>File Name</th>
                                <th style="width: 150px;">Date Uploaded</th>
                                <th style="width: 120px;">Annex Type</th>
                                <th style="width: 120px;" class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Federation files injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Pass data to modal
        document.addEventListener("click", function (e) {
            if (e.target.closest(".btn-upload")) {
                let btn = e.target.closest(".btn-upload");
                let id = btn.getAttribute("data-id");
                let title = btn.getAttribute("data-title");
                
                document.getElementById("modalComplianceId").value = id;
                document.getElementById("modalTitle").value = title;
            }
        });

        // Add dynamic file input
        document.getElementById("addFileBtn").addEventListener("click", function() {
            let container = document.getElementById("fileInputsContainer");
            let div = document.createElement("div");
            div.className = "mb-2 d-flex gap-2";
            div.innerHTML = `
                <input type="file" name="SubmissionFiles" class="form-control" accept="application/pdf" required />
                <button type="button" class="btn btn-danger btn-sm remove-file"><i class="bi bi-trash"></i></button>
            `;
            container.appendChild(div);
        });

        // Remove file input
        document.getElementById("fileInputsContainer").addEventListener("click", function(e) {
            if (e.target.closest(".remove-file")) {
                e.target.closest(".remove-file").parentElement.remove();
            }
        });

        // View Details Logic
        function openDetailsModal(id) {
            // Clear previous data
            document.getElementById('modalDetailsTitle').innerText = 'Loading...';
            document.getElementById('modalDetailsType').innerText = '';
            document.getElementById('modalDetailsDueDate').innerText = '';
            document.getElementById('modalDetailsStatus').innerText = '';
            document.getElementById('modalDocumentsTable').querySelector('tbody').innerHTML = '<tr><td colspan="3" class="text-center">Loading...</td></tr>';

            var modal = new bootstrap.Modal(document.getElementById('viewComplianceModal'));
            modal.show();

            fetch('@Url.Action("GetComplianceDetails", "BarangaySk")/' + id)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    // Populate Header
                    // Use camelCase properties from JSON response
                    var title = data.title || "Compliance Details";
                    document.getElementById('modalDetailsTitle').innerText = title;
                    
                    document.getElementById('modalDetailsType').innerText = data.complianceType || '-';
                    
                    var dateStr = data.dueDate;
                    if(dateStr) {
                        document.getElementById('modalDetailsDueDate').innerText = new Date(dateStr).toLocaleDateString();
                    }

                    var status = data.complianceStatus;
                    var badge = document.getElementById('modalDetailsStatus');
                    badge.innerText = status;
                    badge.className = 'badge';
                    if(status === 'Approved' || status === 'Completed') badge.classList.add('bg-success');
                    else if(status === 'Rejected' || status === 'Returned') badge.classList.add('bg-danger');
                    else badge.classList.add('bg-warning', 'text-dark');

                    // Populate Documents
                    var tbody = document.getElementById('modalDocumentsTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    var docs = data.documents || [];
                    var proposalDocs = data.proposalDocuments || [];
                    
                    // Combine compliance documents and proposal documents
                    var allDocs = [];
                    
                    // Add compliance documents
                    docs.forEach(doc => {
                        allDocs.push({
                            fileName: doc.fileName,
                            fileUrl: doc.fileUrl,
                            status: doc.status,
                            remarks: doc.remarks
                        });
                    });
                    
                    // Add proposal documents with their review status
                    proposalDocs.forEach(doc => {
                        var fileUrl = doc.fileUrl;
                        // Only add "/" if not already present
                        if (fileUrl && !fileUrl.startsWith('/')) {
                            fileUrl = '/' + fileUrl;
                        }
                        allDocs.push({
                            fileName: doc.fileName,
                            fileUrl: fileUrl,
                            status: doc.status || 'Pending',
                            remarks: doc.remarks || 'Project proposal document'
                        });
                    });
                    
                    if(allDocs.length > 0) {
                        allDocs.forEach(doc => {
                            var statusClass = 'bg-secondary';
                            if(doc.status === 'Approved') statusClass = 'bg-success';
                            else if(doc.status === 'Rejected') statusClass = 'bg-danger';
                            else if(doc.status === 'Pending') statusClass = 'bg-warning text-dark';

                            var row = `
                                <tr>
                                    <td><a href="${doc.fileUrl}" target="_blank"><i class="bi bi-file-earmark-pdf"></i> ${doc.fileName}</a></td>
                                    <td><span class="badge ${statusClass}">${doc.status}</span></td>
                                    <td class="small text-muted">${doc.remarks || ''}</td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="3" class="text-center">No documents found.</td></tr>';
                    }

                    // Display federation uploaded files
                    var federationTbody = document.getElementById('federationFilesTable').querySelector('tbody');
                    federationTbody.innerHTML = '';
                    
                    if (data.federationFiles && data.federationFiles.length > 0) {
                        data.federationFiles.forEach(file => {
                            var row = `
                                <tr>
                                    <td><a href="/${file.fileUrl}" target="_blank"><i class="bi bi-file-earmark-pdf text-danger me-1"></i>${file.fileName}</a></td>
                                    <td>${new Date(file.dateAdded).toLocaleDateString()}</td>
                                    <td class="text-center">
                                        <a href="/${file.fileUrl}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                    </td>
                                </tr>
                            `;
                            federationTbody.innerHTML += row;
                        });
                    } else {
                        federationTbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No federation uploaded files.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('modalDocumentsTable').querySelector('tbody').innerHTML = '<tr><td colspan="3" class="text-danger text-center">Failed to load details.</td></tr>';
                });
        }

        // Open Barangay SK Documents Modal
        function openBarangayDocsModal(projectId, projectTitle) {
            document.getElementById('barangayDocsProjectTitle').innerText = projectTitle;
            document.getElementById('barangayDocsTable').querySelector('tbody').innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';
            
            var modal = new bootstrap.Modal(document.getElementById('barangayDocsModal'));
            modal.show();

            fetch('@Url.Action("GetProjectBarangayDocuments", "BarangaySk")/' + projectId)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    var tbody = document.getElementById('barangayDocsTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (data.documents && data.documents.length > 0) {
                        data.documents.forEach(doc => {
                            var row = `
                                <tr>
                                    <td><i class="bi bi-file-earmark-pdf text-danger me-1"></i>${doc.fileName}</td>
                                    <td>${doc.description || 'Document'}</td>
                                    <td>${new Date(doc.dateAdded).toLocaleDateString()}</td>
                                    <td class="text-center">
                                        <a href="${doc.fileUrl.startsWith('/') ? doc.fileUrl : '/' + doc.fileUrl}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No documents found.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('barangayDocsTable').querySelector('tbody').innerHTML = '<tr><td colspan="4" class="text-danger text-center">Failed to load documents.</td></tr>';
                });
        }

        // Open Federation Documents Modal
        function openFederationDocsModal(projectId, projectTitle) {
            document.getElementById('federationDocsProjectTitle').innerText = projectTitle;
            document.getElementById('federationDocsTable').querySelector('tbody').innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';
            
            var modal = new bootstrap.Modal(document.getElementById('federationDocsModal'));
            modal.show();

            fetch('@Url.Action("GetProjectFederationDocuments", "BarangaySk")/' + projectId)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    var tbody = document.getElementById('federationDocsTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (data.documents && data.documents.length > 0) {
                        data.documents.forEach(doc => {
                            var row = `
                                <tr>
                                    <td><i class="bi bi-file-earmark-pdf text-danger me-1"></i>${doc.fileName}</td>
                                    <td>${doc.description || 'Document'}</td>
                                    <td>${new Date(doc.dateAdded).toLocaleDateString()}</td>
                                    <td class="text-center">
                                        <a href="${doc.fileUrl.startsWith('/') ? doc.fileUrl : '/' + doc.fileUrl}" target="_blank" class="btn btn-sm btn-info text-white">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No federation documents found.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('federationDocsTable').querySelector('tbody').innerHTML = '<tr><td colspan="4" class="text-danger text-center">Failed to load documents.</td></tr>';
                });
        }

        // Open SK Federation Files Modal for Compliance Items
        function openFederationFilesModal(complianceId, complianceTitle) {
            document.getElementById('federationFilesComplianceTitle').value = complianceTitle;
            document.getElementById('federationFilesTable').querySelector('tbody').innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';
            
            var modal = new bootstrap.Modal(document.getElementById('federationFilesModal'));
            modal.show();

            fetch('@Url.Action("GetComplianceFederationFiles", "BarangaySk")/' + complianceId)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    var tbody = document.getElementById('federationFilesTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (data.federationFiles && data.federationFiles.length > 0) {
                        data.federationFiles.forEach(file => {
                            var fileUrl = file.fileUrl.startsWith('/') ? file.fileUrl : '/' + file.fileUrl;
                            // Determine annex type from description (if available)
                            var annexType = '';
                            var annexBadge = '';
                            if (file.description && file.description.toLowerCase().includes('annex h')) {
                                annexType = 'Annex H';
                                annexBadge = '<span class="badge" style="background-color: #FFC107; color: #000;"><i class="bi bi-folder me-1"></i>Annex H</span>';
                            } else if (file.description && file.description.toLowerCase().includes('annex i')) {
                                annexType = 'Annex I';
                                annexBadge = '<span class="badge" style="background-color: #FFC107; color: #000;"><i class="bi bi-folder me-1"></i>Annex I</span>';
                            } else {
                                annexBadge = file.description || '-';
                            }
                            var row = `
                                <tr>
                                    <td><i class="bi bi-file-earmark-pdf text-danger me-1"></i>${file.fileName}</td>
                                    <td>${new Date(file.dateAdded).toLocaleDateString()}</td>
                                    <td>${annexBadge}</td>
                                    <td class="text-center">
                                        <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No federation uploaded files.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('federationFilesTable').querySelector('tbody').innerHTML = '<tr><td colspan="3" class="text-danger text-center">Failed to load files.</td></tr>';
                });
        }

        // Filter Reports Table
        function filterReportsTable() {
            var searchValue = document.getElementById('projectSearchFilter').value.toLowerCase();
            var table = document.getElementById('reportsTable');
            var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (var i = 0; i < rows.length; i++) {
                var projectTitle = rows[i].querySelector('.project-title').innerText.toLowerCase();
                if (projectTitle.includes(searchValue)) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        // Print Generation Reports
        function printGenerationReports() {
            var table = document.getElementById('reportsTable');
            var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            var printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Generation of Reports</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #0d6efd; margin-bottom: 10px; }
                        .subtitle { text-align: center; color: #6c757d; margin-bottom: 30px; }
                        .project-section { margin-bottom: 40px; page-break-inside: avoid; }
                        .project-header { background-color: #f8f9fa; padding: 15px; border-left: 4px solid #0d6efd; margin-bottom: 15px; }
                        .project-title { font-size: 18px; font-weight: bold; color: #0d6efd; margin-bottom: 5px; }
                        .project-info { display: grid; grid-template-columns: 150px 1fr; gap: 10px; margin-bottom: 15px; }
                        .info-label { font-weight: bold; color: #495057; }
                        .info-value { color: #212529; }
                        .documents-section { margin-top: 15px; }
                        .documents-title { font-weight: bold; color: #0d6efd; margin-bottom: 10px; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; }
                        .document-list { list-style-type: none; padding-left: 0; }
                        .document-item { padding: 8px; margin-bottom: 5px; background-color: #f8f9fa; border-left: 3px solid #28a745; }
                        .document-type { font-weight: bold; color: #28a745; }
                        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
                        .status-approved { background-color: #d1e7dd; color: #0f5132; }
                        .status-pending { background-color: #fff3cd; color: #664d03; }
                        .status-rejected { background-color: #f8d7da; color: #842029; }
                        @@media print {
                            .project-section { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Generation of Reports</h1>
                    <div class="subtitle">Approved Projects</div>
            `;
            
            var projectPromises = [];
            
            for (var i = 0; i < rows.length; i++) {
                if (rows[i].style.display === 'none') continue; // Skip filtered out rows
                
                var projectId = rows[i].getAttribute('data-project-id');
                var projectTitle = rows[i].querySelector('.project-title').innerText;
                var projectStatus = rows[i].querySelector('.project-status').innerText;
                var dateSubmitted = rows[i].querySelector('.date-submitted').innerText;
                
                // Fetch documents for this project
                var promise = Promise.all([
                    fetch('@Url.Action("GetProjectBarangayDocuments", "BarangaySk")/' + projectId).then(r => r.json()),
                    fetch('@Url.Action("GetProjectFederationDocuments", "BarangaySk")/' + projectId).then(r => r.json())
                ]).then(([barangayDocs, federationDocs]) => {
                    return {
                        projectTitle: projectTitle,
                        projectStatus: projectStatus,
                        dateSubmitted: dateSubmitted,
                        barangayDocs: barangayDocs.documents || [],
                        federationDocs: federationDocs.documents || []
                    };
                });
                
                projectPromises.push(promise);
            }
            
            if (projectPromises.length === 0) {
                alert('No projects to print.');
                return;
            }
            
            Promise.all(projectPromises).then(projects => {
                projects.forEach(project => {
                    var statusClass = project.projectStatus === 'Approved' ? 'status-approved' : 
                                     project.projectStatus === 'Pending' ? 'status-pending' : 'status-rejected';
                    
                    printContent += `
                        <div class="project-section">
                            <div class="project-header">
                                <div class="project-title">${project.projectTitle}</div>
                            </div>
                            <div class="project-info">
                                <div class="info-label">Status:</div>
                                <div class="info-value"><span class="status-badge ${statusClass}">${project.projectStatus}</span></div>
                                <div class="info-label">Date Submitted:</div>
                                <div class="info-value">${project.dateSubmitted}</div>
                            </div>
                            
                            <div class="documents-section">
                                <div class="documents-title">Barangay SK Documents</div>
                                <ul class="document-list">
                    `;
                    
                    if (project.barangayDocs.length > 0) {
                        project.barangayDocs.forEach(doc => {
                            printContent += `
                                <li class="document-item">
                                    <span class="document-type">${doc.description || 'Document'}:</span> ${doc.fileName}
                                </li>
                            `;
                        });
                    } else {
                        printContent += '<li class="document-item">No documents found.</li>';
                    }
                    
                    printContent += `
                                </ul>
                            </div>
                            
                            <div class="documents-section">
                                <div class="documents-title">Barangay Federation Documents</div>
                                <ul class="document-list">
                    `;
                    
                    if (project.federationDocs.length > 0) {
                        project.federationDocs.forEach(doc => {
                            printContent += `
                                <li class="document-item">
                                    <span class="document-type">${doc.description || 'Document'}:</span> ${doc.fileName}
                                </li>
                            `;
                        });
                    } else {
                        printContent += '<li class="document-item">No federation documents found.</li>';
                    }
                    
                    printContent += `
                                </ul>
                            </div>
                        </div>
                    `;
                });
                
                printContent += `
                </body>
                </html>
                `;
                
                var printWindow = window.open('', '', 'height=800,width=1000');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            }).catch(error => {
                console.error('Error fetching documents:', error);
                alert('Failed to load all documents for printing.');
            });
        }
    </script>
}